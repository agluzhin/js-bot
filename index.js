// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É "dotenv" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–≤ –Ω–µ–º –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞).
require("dotenv").config();
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–ª–∞—Å—Å—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ "grammY" (–Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–æ–≤).
const {
  Bot,
  Keyboard,
  GrammyError,
  HttpError,
  InlineKeyboard,
} = require("grammy");
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ—Å–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ "utils.js".
const { getRandomQuestion, getCorrectAnswer } = require("./utils");

// –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ "Bot" —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞.
const bot = new Bot(process.env.BOT_API_KEY);

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã "start".
bot.command("start", async (context) => {
  // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–µ—Ä–µ—á–Ω–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–º–∞—Ç–∏–∫.
  const startKeyborad = new Keyboard()
    .text("HTML")
    .text("CSS")
    .row()
    .text("JavaScript")
    .text("React")
    .row()
    .text("–°–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å")
    .resized();

  // –í—ã–≤–æ–¥–∏–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
  await context.reply(
    "–ü—Ä–∏–≤–µ—Ç!üëã\n\n–Ø - CTB bot helper. –° –º–æ–µ–π –ø–æ–º–æ—â—å—é —Ç—ã —Å–º–æ–∂–µ—à—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —É—Å—Ç–Ω—ã–º –æ–ø—Ä–æ—Å–∞–º –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ '<b>–¶–∏—Ñ—Ä–æ–≤–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞</b>'.\n\n–ù—É, –∞ —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –≤—Å–µ—Ö <b>—Å–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –≤ –æ–±–ª–∞—Å—Ç–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</b> –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª <b>–ø–µ—Ä–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</b>: @petrshcherbachenko üìù",
    {
      parse_mode: "HTML",
    }
  );

  // –£—Ç–æ—á–Ω—è–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞, –≤—ã–≤–æ–¥—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
  await context.reply(
    "–° —á–µ–≥–æ –∂–µ–ª–∞–µ—Ç–µ –Ω–∞—á–∞—Ç—å? –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –≤–æ—Å–ø—Ä–æ—Å–∞ –≤ –º–µ–Ω—é üëá",
    {
      reply_markup: startKeyborad,
    }
  );
});

// –°–æ–∑–¥–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–µ–º).
bot.hears(
  ["HTML", "CSS", "JavaScript", "React", "–°–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å"],
  async (context) => {
    // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —á–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–º–æ–π => –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É.
    const topic = context.message.text.toLowerCase();
    // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç, –ø–æ–ª—É—á–∞–µ–º—ã–π –ø–æ—Å–ª–µ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ "getRandomQuestion".
    const { question, questionTopic } = getRandomQuestion(topic);

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è inline-–∫–ª–∞–≤–∏—Ç—É—Ä—ã (–¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤).
    let inlineKeyboard;

    // –ï—Å–ª–∏ —É –≤–æ–ø—Ä–æ—Å–∞ –µ—Å—Ç—å "–æ–ø—Ü–∏–∏/–≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
    if (question.hasOptions) {
      // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∞–º –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ —Ç–µ–º–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤.
      const buttonRows = question.options.map((option) => [
        InlineKeyboard.text(
          option.text,
          JSON.stringify({
            type: `${questionTopic}-option`,
            isCorrect: option.isCorrect,
            questionId: question.id,
          })
        ),
      ]);

      // –ü–µ—Ä–µ–¥–∞–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω—É—é –∏–∑ –∫–Ω–æ–ø–æ–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
      inlineKeyboard = InlineKeyboard.from(buttonRows);
    } else {
      // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ—Ç–∫—Ä—ã—Ç—ã–π, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É "–£–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç".
      inlineKeyboard = new InlineKeyboard().text(
        "–£–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç",
        JSON.stringify({
          type: questionTopic,
          questionId: question.id,
        })
      );
    }

    // –í—ã–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–ª–∞–≤–∏—Ç—É—Ä—É.
    await context.reply(question.text, {
      reply_markup: inlineKeyboard,
    });
  }
);

// –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ–≥–¥–∞ –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç "callback data" - –æ—Ç–≤–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É).
bot.on("callback_query:data", async (context) => {
  // –†–∞—Å—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—É—é "callback data".
  const callbackData = JSON.parse(context.callbackQuery.data);

  // –ï—Å–ª–∏ –∫–ª—é—á "type" –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –ø—Ä–∏–ø–∏—Å–∫—É "option".
  if (!callbackData.type.includes("option")) {
    // –¢–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ç–µ–º–µ –∏ id –≤–æ–ø—Ä–æ—Å–∞.
    const answer = getCorrectAnswer(callbackData.type, callbackData.questionId);
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
    await context.reply(answer, {
      parse_mode: "HTML",
      disable_web_page_preview: true,
    });
    // –î–æ–∂–∏–¥–∞–µ–º—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ "callback data".
    await context.answerCallbackQuery();
    // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏.
    return;
  }

  // –í —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ –≤–æ–ø—Ä–æ—Å —Å "–æ–ø—Ü–∏—è–º–∏", –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞.
  if (callbackData.isCorrect) {
    // –ï—Å–ª–∏ –≤–µ—Ä–Ω–æ - —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º.
    await context.reply("–í–µ—Ä–Ω–æ ‚úÖ");
    // –î–æ–∂–∏–¥–∞–µ–º—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ "callback data".
    await context.answerCallbackQuery();
    // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏.
    return;
  }

  // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–µ–Ω—ã–π, —Ç–æ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–µ–º—ã –∏ id –≤–æ–ø—Ä–æ—Å–∞.
  const answer = getCorrectAnswer(
    callbackData.type.split("-")[0],
    callbackData.questionId
  );
  // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ç–æ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π –∏ –≤—ã–≤–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
  await context.reply(`–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${answer}`);
  // –î–æ–∂–∏–¥–∞–µ–º—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ "callback data".
  await context.answerCallbackQuery();
});

// –û—Ç–ª–æ–≤ –æ—à–∏–±–æ–∫.
bot.catch((error) => {
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏.
  const context = error.context;
  // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∫–æ–Ω—Å–æ–ª—å.
  console.error(`Error while handling update ${context.update.update_id}:`);
  // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏.
  const e = error.error;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.
  if (e instanceof GrammyError) {
    // –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –≤—ã–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å.
    console.error("Error in request:", e.description);
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç –æ—à–±–∏–∫–∏ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –∑–∞–ø—Ä–æ—Å–∞–º "telegram api" –ø–æ —Å–µ—Ç–µ–≤–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É.
  } else if (e instanceof HttpError) {
    // –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ telegra, –≤—ã–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å.
    console.error("Could not contact Telegram:", e);
  } else {
    // –ö–æ–≥–¥–∞ –æ—à–∏–±–∫–∞ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –Ω–∏ –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ, –Ω–∏ –∫ telegram, –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –æ—à–∏–±–∫–µ.
    console.error("Unknown error:", e);
  }
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞.
bot.start();
